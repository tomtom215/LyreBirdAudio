# LyreBirdAudio Log Rotation Configuration
# Prevents disk exhaustion from log accumulation
#
# Installation:
#   sudo cp config/lyrebird-logrotate.conf /etc/logrotate.d/lyrebird
#
# Test configuration:
#   sudo logrotate -d /etc/logrotate.d/lyrebird
#
# Force immediate rotation:
#   sudo logrotate -f /etc/logrotate.d/lyrebird

# MediaMTX server log
/var/log/mediamtx.out {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    create 0644 root root
    size 50M

    postrotate
        # Signal MediaMTX to reopen log file (if supported)
        # Otherwise, it will naturally start writing to new file
        systemctl kill -s HUP mediamtx 2>/dev/null || true
    endscript
}

# Stream manager logs
/var/log/lyrebird-stream-manager.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    create 0644 root root
    size 20M
    sharedscripts

    postrotate
        # Signal stream manager to reopen log file
        pkill -USR1 -f lyrebird-stream-manager.sh 2>/dev/null || true
    endscript
}

# FFmpeg per-device logs (multiple files in directory)
/var/log/lyrebird/*.log {
    daily
    rotate 3
    compress
    delaycompress
    missingok
    notifempty
    create 0644 root root
    size 10M
    sharedscripts

    # Keep recent logs for troubleshooting, but rotate aggressively
    # to prevent disk fill on devices with many microphones
}

# LyreBird orchestrator and updater logs
/var/log/lyrebird-orchestrator.log
/var/log/lyrebird-updater.log {
    weekly
    rotate 4
    compress
    delaycompress
    missingok
    notifempty
    create 0644 root root
    size 10M
}

# Diagnostics log (rarely written, keep longer)
/var/log/lyrebird-diagnostics.log {
    monthly
    rotate 6
    compress
    delaycompress
    missingok
    notifempty
    create 0644 root root
    size 5M
}

# USB audio mapper logs
/var/log/usb-audio-mapper.log {
    weekly
    rotate 4
    compress
    delaycompress
    missingok
    notifempty
    create 0644 root root
    size 5M
}
